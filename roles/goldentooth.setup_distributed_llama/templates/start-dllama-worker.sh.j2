#!/bin/bash
set -euo pipefail

# Distributed LLaMA Worker Node Startup Script
# Generated by Ansible - do not edit manually

echo "🚀 Starting Distributed LLaMA Worker Node on {{ inventory_hostname }}"

# Configuration
DLLAMA_BIN="{{ distributed_llama.install_dir }}/bin/dllama"
LOG_DIR="{{ distributed_llama.install_dir }}/logs"
WORKER_PORT="${DLLAMA_PORT:-{{ distributed_llama.worker_port }}}"
THREADS="${DLLAMA_THREADS:-{{ distributed_llama.threads }}}"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Log startup information
echo "$(date -Iseconds) - Starting worker on {{ inventory_hostname }}:${WORKER_PORT}" >> "${LOG_DIR}/worker.log"
echo "$(date -Iseconds) - Using ${THREADS} threads" >> "${LOG_DIR}/worker.log"

# Check if binary exists
if [ ! -x "${DLLAMA_BIN}" ]; then
    echo "❌ Distributed LLaMA binary not found: ${DLLAMA_BIN}"
    exit 1
fi

# Start worker node
echo "🔧 Starting worker with ${THREADS} threads on port ${WORKER_PORT}"
exec "${DLLAMA_BIN}" worker \
    --port "${WORKER_PORT}" \
    --nthreads "${THREADS}" \
    2>&1 | tee -a "${LOG_DIR}/worker.log"